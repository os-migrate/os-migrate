

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contributing Code &mdash; os-migrate  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fe63c2af" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=7ab3649f" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributing Documentation" href="contributing-docs.html" />
    <link rel="prev" title="General Contribution Guidelines" href="contributing-general.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            os-migrate
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/README.html">OS Migrate User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roles.html">Documented roles in os-migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Documented modules in os-migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="README.html">OS Migrate Developer Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="design.html">OS Migrate Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-env-setup.html">Development Environment Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing-general.html">General Contribution Guidelines</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Contributing Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#adding-a-new-role">Adding a New Role</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-role-skeleton-automatically">Creating the role skeleton automatically</a></li>
<li class="toctree-l4"><a class="reference internal" href="#resources">Resources</a></li>
<li class="toctree-l4"><a class="reference internal" href="#export-roles">Export Roles</a></li>
<li class="toctree-l4"><a class="reference internal" href="#import-roles">Import Roles</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#writing-tests">Writing Tests</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#functional-tests">Functional Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unit-tests">Unit Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integration-tests">Integration Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#documentation-and-examples">Documentation and Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-execution-in-ci">Test Execution in CI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#review-and-inspection">Review and Inspection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#location-of-tests">Location of Tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#special-considerations">Special Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#necessary-documentation">Necessary Documentation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contributing-docs.html">Contributing Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="releasing.html">Releasing the OS Migrate collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev-env-vagrant-non-containerized.html">Installing Vagrant directly on host (alternative path)</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">os-migrate</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="README.html">OS Migrate Developer Documentation</a></li>
      <li class="breadcrumb-item active">Contributing Code</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/devel/contributing-code.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="contributing-code">
<h1>Contributing Code<a class="headerlink" href="#contributing-code" title="Link to this heading"></a></h1>
<p>As an open source project, OS Migrate welcomes contributions from the
community at large. The following guide provides information on how to
add a new role to the project and where additional testing or
documentation artifacts should be added. This isn’t an exhaustive
reference and is a living document subject to change as needed when
the project formalizes any practice or pattern.</p>
<section id="adding-a-new-role">
<h2>Adding a New Role<a class="headerlink" href="#adding-a-new-role" title="Link to this heading"></a></h2>
<p>The most common contribution to OS Migrate is adding a new role to
support the export or import of resources. The construction of the roles
will likely follow a similar pattern. Each role also has specific unit
and functional test requirements. The most common pattern for adding a
new role will follow these steps:</p>
<ul class="simple">
<li><p>Add a resource class to <code class="docutils literal notranslate"><span class="pre">os_migrate/plugins/module_utils</span></code> that
inherits from
<code class="docutils literal notranslate"><span class="pre">ansible_collections.os_migrate.os_migrate.plugins.module_utils.resource.Resource</span></code></p></li>
<li><p>Add a unit test to <code class="docutils literal notranslate"><span class="pre">os_migrate/tests/unit</span></code> to test serializing and
de-serializing data, and any other functionality your class may have.</p></li>
<li><p>Create a new module in <code class="docutils literal notranslate"><span class="pre">os_migrate/plugins/modules</span></code> to facilitate
the import or export of the resource.</p></li>
<li><p>Add a new playbook to <code class="docutils literal notranslate"><span class="pre">os_migrate/playbooks</span></code>.</p></li>
<li><p>Add a new role to <code class="docutils literal notranslate"><span class="pre">os_migrate/roles</span></code>.</p></li>
<li><p>Add functional tests to <code class="docutils literal notranslate"><span class="pre">tests/func</span></code> that test primary use,
idempotency, and updates as a minimum. Additional tests as necessary.</p></li>
<li><p>Add documentation within classes and roles/playbooks as required.
Update developer or user documentation as needed.</p></li>
</ul>
<section id="creating-the-role-skeleton-automatically">
<h3>Creating the role skeleton automatically<a class="headerlink" href="#creating-the-role-skeleton-automatically" title="Link to this heading"></a></h3>
<p>Adding roles into os-migrate can be easily achieved by
creating the role structure skeleton automatically.</p>
<p>From the repository root directory execute:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ansible-playbook<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-i<span class="w"> </span><span class="s1">&#39;localhost,&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>./scripts/role-addition.yml<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">ansible_connection</span><span class="o">=</span><span class="nb">local</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>-e<span class="w"> </span><span class="nv">role_name</span><span class="o">=</span>import_example_resource
</pre></div>
</div>
<p>This command will generate the role, the default variables file,
and the documentation stub.</p>
</section>
<section id="resources">
<h3>Resources<a class="headerlink" href="#resources" title="Link to this heading"></a></h3>
<p>Resources are the primary data structures that are exported from and
imported to clouds. In
<code class="docutils literal notranslate"><span class="pre">os_migrate/plugins/module_utils/resource.py</span></code>, there is a
<code class="docutils literal notranslate"><span class="pre">Resource</span></code> class provided for your new resource to inherit from. It
provides a way to quickly build an organized class that uses
openstacksdk to retrieve, create and update data within a connected
OpenStack tenant. See how other classes in the <code class="docutils literal notranslate"><span class="pre">module_utils</span></code>
directory inherit from <code class="docutils literal notranslate"><span class="pre">Resource</span></code> for inspiration.</p>
<p>Two very important properties are the ‘params’ and ‘_info’, as these are
the primary data fields that will be exported and imported. At a
minimum, the name property of any resource should be in params_from_sdk,
and most likely addresses should be there too. The difference between
info and params is:</p>
<ul class="simple">
<li><p>A property that would be an ‘_info’ type is something that we don’t
want or cannot “make the same” in the destination cloud. For example,
typically UUIDs can’t be the same between two tenants so an ‘id’
property should remain in info.</p></li>
<li><p>A property that would be in a ‘params’ type are things that we do
want to copy to the destination cloud. These typically also get
looked at when we’re making sure the import behavior is idempotent.
I.e. when we re-run import playbooks, things that already got
imported before are not attempted to be imported again.</p></li>
</ul>
</section>
<section id="export-roles">
<h3>Export Roles<a class="headerlink" href="#export-roles" title="Link to this heading"></a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">defaults/main.yml</span></code> file, at a minimum you will need to
define the <code class="docutils literal notranslate"><span class="pre">os_migrate_[resource]_filter</span></code> variable to support
filtering of resources by the name property.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">meta/main.yml</span></code> file you will likely just need to add the
following default content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">galaxy_info</span><span class="p">:</span>
<span class="w">  </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os-migrate</span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os-migrate resource</span>
<span class="w">  </span><span class="nt">company</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Red Hat</span>
<span class="w">  </span><span class="nt">license</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apache-2.0</span>
<span class="w">  </span><span class="nt">min_ansible_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.9&quot;</span>
<span class="w">  </span><span class="nt">platforms</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fedora</span>
<span class="w">      </span><span class="nt">versions</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;34&quot;</span>
<span class="w">  </span><span class="nt">galaxy_tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;osmigrate&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os_migrate.os_migrate.prelude_src</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">tasks/main.yml</span></code> file, add your Ansible tasks for exporting the
data. A common pattern is retrieving data from an OpenStack tenant via a
<a class="reference external" href="https://docs.ansible.com/ansible/latest/collections/openstack/cloud/index.html">cloud
module</a>
, creating a collection of name/id pairs for export, filtering the names
for specific resources, and then calling the module you created for
export.</p>
</section>
<section id="import-roles">
<h3>Import Roles<a class="headerlink" href="#import-roles" title="Link to this heading"></a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">defaults/main.yml</span></code> file, at a minimum you will need to
define the same <code class="docutils literal notranslate"><span class="pre">os_migrate_[resource]_filter</span></code> variable as with
export, and <code class="docutils literal notranslate"><span class="pre">import_[resource]_validate_file:</span> <span class="pre">true</span></code> variable to set
whether or not the import data file should be validated for this
role. In most cases, it should be set to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">meta/main.yml</span></code> file you will likely just need to add the
following default content:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nn">---</span>
<span class="nt">galaxy_info</span><span class="p">:</span>
<span class="w">  </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os-migrate</span>
<span class="w">  </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os-migrate resource</span>
<span class="w">  </span><span class="nt">company</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Red Hat</span>
<span class="w">  </span><span class="nt">license</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apache-2.0</span>
<span class="w">  </span><span class="nt">min_ansible_version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2.9&quot;</span>
<span class="w">  </span><span class="nt">platforms</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fedora</span>
<span class="w">      </span><span class="nt">versions</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;34&quot;</span>
<span class="w">  </span><span class="nt">galaxy_tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;osmigrate&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">os_migrate.os_migrate.prelude_dst</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">tasks/main.yml</span></code> file, add your Ansible tasks for importing the
data. A common pattern is validating the data file created by the
associated export role, reading the data file and then calling the
module you created for import.</p>
</section>
</section>
<section id="writing-tests">
<h2>Writing Tests<a class="headerlink" href="#writing-tests" title="Link to this heading"></a></h2>
<p>For newly implemented resources, ensure comprehensive test coverage by following this checklist:</p>
<section id="functional-tests">
<h3>Functional Tests<a class="headerlink" href="#functional-tests" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Ensure both import and export functionalities are tested, not just idempotency.</p></li>
<li><p>Include tests for admin-only resources, ensuring they are renamed before import.</p></li>
<li><p>Test resources as a tenant whenever possible to ensure broader coverage.</p></li>
<li><p>For resources with special properties like <code class="docutils literal notranslate"><span class="pre">links</span></code> or <code class="docutils literal notranslate"><span class="pre">extra_specs</span></code>, write detailed tests inspecting these properties closely.</p></li>
</ul>
</section>
<section id="unit-tests">
<h3>Unit Tests<a class="headerlink" href="#unit-tests" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Write unit tests for each new module created, focusing on the logic within the module.</p></li>
<li><p>Ensure that edge cases and error handling paths are covered in unit tests.</p></li>
</ul>
</section>
<section id="integration-tests">
<h3>Integration Tests<a class="headerlink" href="#integration-tests" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Add integration tests that cover the entire process of exporting and then importing the resource, verifying the integrity and consistency of the data.</p></li>
<li><p>Verify that the resource behaves as expected in the context of the os-migrate ecosystem.</p></li>
</ul>
</section>
<section id="documentation-and-examples">
<h3>Documentation and Examples<a class="headerlink" href="#documentation-and-examples" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">DOCUMENTATION</span></code> constant of each module, include examples of how to use the module in a playbook.</p></li>
<li><p>Ensure that the <code class="docutils literal notranslate"><span class="pre">README.md</span></code> file for the new role is comprehensive, covering the role’s purpose, usage, and any dependencies.</p></li>
</ul>
</section>
<section id="test-execution-in-ci">
<h3>Test Execution in CI<a class="headerlink" href="#test-execution-in-ci" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Confirm that all tests are executed in the Continuous Integration (CI) environment before merging.</p></li>
<li><p>If a feature is merged without proper tests due to specific circumstances, create a technical debt tracking card to follow up.</p></li>
</ul>
</section>
<section id="review-and-inspection">
<h3>Review and Inspection<a class="headerlink" href="#review-and-inspection" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Conduct thorough reviews, especially when introducing new resources, to catch potential issues early.</p></li>
<li><p>Implement policies or checklists in development documentation to ensure test soundness and coverage.</p></li>
</ul>
</section>
<section id="location-of-tests">
<h3>Location of Tests<a class="headerlink" href="#location-of-tests" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Place functional and integration tests in the <code class="docutils literal notranslate"><span class="pre">tests/e2e</span></code> or <code class="docutils literal notranslate"><span class="pre">tests/func</span></code> directory respectively, following the existing structure for similar resources.</p></li>
<li><p>Unit tests should reside alongside the modules they are testing, in the <code class="docutils literal notranslate"><span class="pre">os_migrate/tests/</span></code> directory.</p></li>
</ul>
</section>
<section id="special-considerations">
<h3>Special Considerations<a class="headerlink" href="#special-considerations" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>For resources that are only accessible by admin users, ensure tests reflect this by running them with appropriate permissions.</p></li>
<li><p>Address any known issues from previous retrospectives, such as fixing the handling of Nova keypairs or ensuring resources are tested in tenant context.</p></li>
</ul>
</section>
<section id="necessary-documentation">
<h3>Necessary Documentation<a class="headerlink" href="#necessary-documentation" title="Link to this heading"></a></h3>
<p>If this is your first time adding a pull request to the os-migrate
repository, add your author information to <code class="docutils literal notranslate"><span class="pre">galaxy.yml</span></code>.</p>
<p>In each Ansible module in <code class="docutils literal notranslate"><span class="pre">os_migrate/plugins/modules</span></code>, there is a
<code class="docutils literal notranslate"><span class="pre">DOCUMENTATION</span></code> constant where you must provide standard
documentation on what the module does and an example of how you would
use it in a playbook.</p>
<p>Each new role must have a <code class="docutils literal notranslate"><span class="pre">README.md</span></code> file as a requirement for
Ansible Galaxy publishing.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="contributing-general.html" class="btn btn-neutral float-left" title="General Contribution Guidelines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contributing-docs.html" class="btn btn-neutral float-right" title="Contributing Documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, os-migrate.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>