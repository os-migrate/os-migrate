- name: get auth token
  openstack.cloud.auth:
    auth: "{{ os_migrate_src_auth }}"
  register: auth_token_src

- name: Create osm_volume
  ansible.builtin.command:
    cmd: openstack volume create --size 1 osm_volume
  environment:
    OS_AUTH_TYPE: token
    OS_AUTH_URL: "{{ os_migrate_src_auth.auth_url }}"
    OS_TOKEN: "{{ auth_token_src.auth_token }}"
    OS_VOLUME_API_VERSION: 3.10
    OS_PROJECT_ID: "{{ os_migrate_src_auth.project_id|default('') }}"
    OS_PROJECT_NAME: "{{ os_migrate_src_auth.project_name|default('') }}"
    OS_PROJECT_DOMAIN_ID: "{{ os_migrate_src_auth.project_domain_id|default('') }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_migrate_src_auth.project_domain_name|default('') }}"
  register: _result
  changed_when: "_result.rc == 0"

- name: Create osm_server
  ansible.builtin.command:
    cmd: |
      openstack server create osm_server
      --flavor "{{ os_migrate_src_osm_server_flavor|default(m1.small) }}"
      --key-name osm_key
      --image "{{ workload_image }}"
      --network osm_net
      --security-group osm_security_group
      --wait
  environment:
    OS_AUTH_TYPE: token
    OS_AUTH_URL: "{{ os_migrate_src_auth.auth_url }}"
    OS_TOKEN: "{{ auth_token_src.auth_token }}"
    OS_PROJECT_ID: "{{ os_migrate_src_auth.project_id|default('') }}"
    OS_PROJECT_NAME: "{{ os_migrate_src_auth.project_name|default('') }}"
    OS_PROJECT_DOMAIN_ID: "{{ os_migrate_src_auth.project_domain_id|default('') }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_migrate_src_auth.project_domain_name|default('') }}"
  register: _result_osm_server
  changed_when: "_result_osm_server.rc == 0"

- name: Register osm_volume id
  ansible.builtin.command:
    cmd: openstack volume list --name osm_volume -f value -c ID
  environment:
    OS_AUTH_TYPE: token
    OS_AUTH_URL: "{{ os_migrate_src_auth.auth_url }}"
    OS_TOKEN: "{{ auth_token_src.auth_token }}"
    OS_VOLUME_API_VERSION: 3.10
    OS_PROJECT_ID: "{{ os_migrate_src_auth.project_id|default('') }}"
    OS_PROJECT_NAME: "{{ os_migrate_src_auth.project_name|default('') }}"
    OS_PROJECT_DOMAIN_ID: "{{ os_migrate_src_auth.project_domain_id|default('') }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_migrate_src_auth.project_domain_name|default('') }}"
  register: osm_volume_id
  changed_when: false

- name: Register osm_server id
  ansible.builtin.command:
    cmd: openstack server list --name osm_server -f value -c ID
  environment:
    OS_AUTH_TYPE: token
    OS_AUTH_URL: "{{ os_migrate_src_auth.auth_url }}"
    OS_TOKEN: "{{ auth_token_src.auth_token }}"
    OS_PROJECT_ID: "{{ os_migrate_src_auth.project_id|default('') }}"
    OS_PROJECT_NAME: "{{ os_migrate_src_auth.project_name|default('') }}"
    OS_PROJECT_DOMAIN_ID: "{{ os_migrate_src_auth.project_domain_id|default('') }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_migrate_src_auth.project_domain_name|default('') }}"
  register: osm_server_id
  changed_when: false

- name: Add volume to osm_server
  ansible.builtin.command:
    cmd: openstack server add volume "{{ osm_server_id.stdout }}" "{{ osm_volume_id.stdout }}"
  environment:
    OS_AUTH_TYPE: token
    OS_AUTH_URL: "{{ os_migrate_src_auth.auth_url }}"
    OS_TOKEN: "{{ auth_token_src.auth_token }}"
    OS_VOLUME_API_VERSION: 3.10
    OS_PROJECT_ID: "{{ os_migrate_src_auth.project_id|default('') }}"
    OS_PROJECT_NAME: "{{ os_migrate_src_auth.project_name|default('') }}"
    OS_PROJECT_DOMAIN_ID: "{{ os_migrate_src_auth.project_domain_id|default('') }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_migrate_src_auth.project_domain_name|default('') }}"
  register: _result_osm_server_add
  changed_when: "_result_osm_server_add.rc == 0"
