- name: Create osm_volume
  openstack.cloud.volume:
    display_name: osm_volume
    size: 1
    auth: "{{ os_migrate_src_auth }}"
    validate_certs: "{{ os_migrate_src_validate_certs|default(omit) }}"
    ca_cert: "{{ os_migrate_src_ca_cert|default(omit) }}"
    client_cert: "{{ os_migrate_src_client_cert|default(omit) }}"
    client_key: "{{ os_migrate_src_client_key|default(omit) }}"

- name: Create osm_server
  openstack.cloud.server:
    name: osm_server
    state: present
    flavor: "{{ os_migrate_src_osm_server_flavor|default(m1.small) }}"
    key_name: osm_key
    image: "{{ workload_image }}"
    network: osm_net
    security_groups: osm_security_group
    volumes:
      - osm_volume
    # We get a floating IP
    # for the workload VM
    auto_ip: true
    userdata: |
      {%- raw -%}#!/bin/bash
      set -euf -o pipefail
      fdisk -l
      dev='/dev/vdc'
      sudo umount "$dev"
      printf "o\nn\np\n1\n\n\nw\n" | sudo fdisk "$dev"
      sudo mkfs.ext4 "${dev}1"
      mkdir test_vol
      sudo mount /dev/vdc1 test_vol
      cd test_vol
      dd if=/dev/urandom of=test.txt bs=1M count=1
      {% endraw %}
    wait: true
    auth: "{{ os_migrate_src_auth }}"
    validate_certs: "{{ os_migrate_src_validate_certs|default(omit) }}"
    ca_cert: "{{ os_migrate_src_ca_cert|default(omit) }}"
    client_cert: "{{ os_migrate_src_client_cert|default(omit) }}"
    client_key: "{{ os_migrate_src_client_key|default(omit) }}"
