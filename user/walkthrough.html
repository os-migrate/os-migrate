<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OS Migrate Walkthrough &mdash; os-migrate  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="General usage notes" href="usage-notes.html" />
    <link rel="prev" title="Upgrading" href="upgrade.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> os-migrate
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="README.html">OS Migrate User Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install-from-galaxy.html">Installation from Galaxy (recommended)</a></li>
<li class="toctree-l2"><a class="reference internal" href="install-from-source.html">Installation from source (when customizing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade.html">Upgrading</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">OS Migrate Walkthrough</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#prerequisites">Prerequisites</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#authentication">Authentication</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameter-file">Parameter file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shortcuts">Shortcuts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#pre-workload-migration">Pre-workload migration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#export-and-import">Export and import</a></li>
<li class="toctree-l4"><a class="reference internal" href="#diagrams">Diagrams</a></li>
<li class="toctree-l4"><a class="reference internal" href="#demo">Demo</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#workload-migration">Workload migration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#process-summary">Process Summary</a></li>
<li class="toctree-l4"><a class="reference internal" href="#preparation">Preparation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#conversion-host-deployment">Conversion host deployment</a></li>
<li class="toctree-l4"><a class="reference internal" href="#export">Export</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migration-parameters">Migration parameters</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ansible-variables">Ansible Variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#migration">Migration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cleanup-of-conversion-hosts">Cleanup of conversion hosts</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">Demo</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="usage-notes.html">General usage notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="variables-guide.html">Variables Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration-params-guide.html">Migration Parameters Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-it-works-workload-migration.html">How it works: Workload migration</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../roles.html">Documented roles in os-migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">Documented modules in os-migrate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devel/README.html">OS Migrate Developer Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">os-migrate</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="README.html">OS Migrate User Documentation</a> &raquo;</li>
      <li>OS Migrate Walkthrough</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/user/walkthrough.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="os-migrate-walkthrough">
<h1>OS Migrate Walkthrough<a class="headerlink" href="#os-migrate-walkthrough" title="Permalink to this heading"></a></h1>
<p>OS Migrate is a framework for OpenStack parallel cloud migration
(migrating content between OpenStack tenants which are not necessarily
in the same cloud). It’s a collection of Ansible playbooks that provide
the basic functionality, but may not fit each use case out of the box.
You can craft custom playbooks using the OS Migrate collection pieces
(roles and modules) as building blocks.</p>
<p>Parallel cloud migration is a way to modernize an OpenStack deployment.
Instead of upgrading an OpenStack cluster in place, a second OpenStack
cluster is deployed alongside, and tenant content is migrated from the
original cluster to the new one. Parallel cloud migration is best suited
for environments which are due for a hardware refresh cycle. It may also
be performed without a hardware refresh, but extra hardware resources
are needed to bootstrap the new cluster. As hardware resources free up
in the original cluster, they can be gradually added to the new cluster.</p>
<p>OS Migrate strictly uses the official OpenStack API and does not utilize
direct database access or other methods to export or import data. The
Ansible playbooks contained in OS Migrate are idempotent. If a command
fails, you can retry with the same command.</p>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/pcm-birds-eye.png"><img alt="OSP-OSP Migration Overview" src="../_images/pcm-birds-eye.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text">OSP-OSP Migration Overview</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The migration is generally performed in this sequence:</p>
<ul class="simple">
<li><p>prerequisites: prepare authentication info, parameter files,</p></li>
<li><p>pre-workload migration, which copies applicable resources into the
destination cloud (e.g. networks, security groups, images) while
workloads keep running in the source cloud,</p></li>
<li><p>workload migration, which stops usage of applicable resources in the
source cloud and moves them into the destination cloud (VMs,
volumes).</p></li>
</ul>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Permalink to this heading"></a></h3>
<p>Users are encouraged to use os-migrate using specific credentials for
each project/tenant, this means <strong>not using the admin user to execute
the resources migration</strong> (unless the resource is owned by the admin
project, e.g. public Glance images).</p>
<p>In case the circumstances require migrating by the <code class="docutils literal notranslate"><span class="pre">admin</span></code> user,
this user needs to have access to the respective projects. There are
two options:</p>
<ul>
<li><p>Add the <code class="docutils literal notranslate"><span class="pre">admin</span></code> user as a <code class="docutils literal notranslate"><span class="pre">_member_</span></code> of each project.</p>
<p>Depending on how many projects need to be migrated this approach seems
to be suboptimal as there are involved several configuration updates in
the projects that will need to be reverted after the migration
completes.</p>
</li>
<li><p>Create a group including the admin user and add the group to each
project as member.</p>
<p>The difference with this approach is that once the migration is
completed, by removing the group, all the references in all the projects
will be removed automatically.</p>
</li>
</ul>
</section>
<section id="parameter-file">
<h3>Parameter file<a class="headerlink" href="#parameter-file" title="Permalink to this heading"></a></h3>
<p>Let’s create an <code class="docutils literal notranslate"><span class="pre">os-migrate-vars.yml</span></code> file with Ansible variables:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_src_auth</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">auth_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://192.168.0.13.199/v3</span><span class="w"></span>
<span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">srcpassword</span><span class="w"></span>
<span class="w">  </span><span class="nt">project_domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Default</span><span class="w"></span>
<span class="w">  </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src</span><span class="w"></span>
<span class="w">  </span><span class="nt">user_domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Default</span><span class="w"></span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src</span><span class="w"></span>
<span class="nt">os_migrate_src_region_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regionOne</span><span class="w"></span>
<span class="nt">os_migrate_dst_auth</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">auth_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://192.167.0.16:5000/v3</span><span class="w"></span>
<span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dstpassword</span><span class="w"></span>
<span class="w">  </span><span class="nt">project_domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Default</span><span class="w"></span>
<span class="w">  </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dst</span><span class="w"></span>
<span class="w">  </span><span class="nt">user_domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Default</span><span class="w"></span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dst</span><span class="w"></span>
<span class="nt">os_migrate_dst_region_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regionOne</span><span class="w"></span>

<span class="nt">os_migrate_data_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/migrator/os-migrate-data</span><span class="w"></span>
</pre></div>
</div>
<p>The file contains the source and destination tenant credentials, a
directory on the migrator host (typically localhost) and a directory
where the exported data will be saved.</p>
<p><strong>If you are migrating content from multiple source projects, make
sure to use a separate data directory for each source project.</strong> In
other words, when changing <code class="docutils literal notranslate"><span class="pre">os_migrate_src_auth</span></code> or
<code class="docutils literal notranslate"><span class="pre">os_migrate_src_region_name</span></code>, make sure to also change
<code class="docutils literal notranslate"><span class="pre">os_migrate_data_dir</span></code>.</p>
<section id="a-note-about-keystone-v2">
<h4>A note about Keystone v2<a class="headerlink" href="#a-note-about-keystone-v2" title="Permalink to this heading"></a></h4>
<p>As depicted in content of the previously defined <code class="docutils literal notranslate"><span class="pre">os-migrate-vars.yml</span></code>
file, the parameters <code class="docutils literal notranslate"><span class="pre">os_migrate_src_auth</span></code> and <code class="docutils literal notranslate"><span class="pre">os_migrate_dst_auth</span></code>
refer to the usage of Keystone v3. In the case of a user needing to
execute a migration between tenants not supporting Keystone v3 the
following error will be raised:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">keystoneauth1</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">discovery</span><span class="o">.</span><span class="n">DiscoveryFailure</span><span class="p">:</span> <span class="n">Cannot</span> <span class="n">use</span> <span class="n">v2</span> <span class="n">authentication</span> <span class="k">with</span> <span class="n">domain</span> <span class="n">scope</span>
</pre></div>
</div>
<p>To fix this issue, the user must adjust their auth parameters:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_src_auth</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">auth_url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://192.168.0.13.199/v2.0</span><span class="w"></span>
<span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">srcpassword</span><span class="w"></span>
<span class="w">  </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src</span><span class="w"></span>
<span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">src</span><span class="w"></span>
<span class="nt">os_migrate_src_region_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regionOne</span><span class="w"></span>
</pre></div>
</div>
<p>Notice that the parameters <code class="docutils literal notranslate"><span class="pre">project_domain_name</span></code> and
<code class="docutils literal notranslate"><span class="pre">user_domain_name</span></code> are removed and the <code class="docutils literal notranslate"><span class="pre">auth_url</span></code> parameter points
to the Keystone v2 endpoint.</p>
</section>
</section>
<section id="shortcuts">
<h3>Shortcuts<a class="headerlink" href="#shortcuts" title="Permalink to this heading"></a></h3>
<p>We will use the OS Migrate collection path and an ansible-playbook
command with the following arguments routinely, so let’s save them as
variables in the shell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">OSM_DIR</span><span class="o">=</span>/home/migrator/.ansible/collections/ansible_collections/os_migrate/os_migrate
<span class="nb">export</span> <span class="nv">OSM_CMD</span><span class="o">=</span><span class="s2">&quot;ansible-playbook -v -i </span><span class="nv">$OSM_DIR</span><span class="s2">/localhost_inventory.yml -e @os-migrate-vars.yml&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="pre-workload-migration">
<h2>Pre-workload migration<a class="headerlink" href="#pre-workload-migration" title="Permalink to this heading"></a></h2>
<p>Workloads require the support of several resources in a given cloud to
operate properly. Some of these resources include networks, subnets,
routers, router interfaces, security groups, and security group rules.
The pre-workload migration process includes exporting these resources
from the source cloud onto the migrator machine, the option to edit the
resources if desired, and importing them into the destination cloud.</p>
<p>Exporting or importing resources is enabled by running the corresponding
playbook from OS Migrate. Let’s look at a concrete example. To export
the networks, run the “export_networks” playbook.</p>
<section id="export-and-import">
<h3>Export and import<a class="headerlink" href="#export-and-import" title="Permalink to this heading"></a></h3>
<p>To export the networks:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/export_networks.yml
</pre></div>
</div>
<p>This will create networks.yml file in the data directory, similar to
this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4.0</span><span class="w"></span>
<span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">_info</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">availability_zones</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nova</span><span class="w"></span>
<span class="w">      </span><span class="nt">created_at</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2020-04-07T14:08:30Z&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">a1eb31f6-2cdc-4896-b582-8950dafa34aa</span><span class="w"></span>
<span class="w">      </span><span class="nt">project_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2f444c71265048f7a9d21f81db6f21a4</span><span class="w"></span>
<span class="w">      </span><span class="nt">qos_policy_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">revision_number</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"></span>
<span class="w">      </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ACTIVE</span><span class="w"></span>
<span class="w">      </span><span class="nt">subnet_ids</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">a5052e10-5e00-432b-a826-29695677aca0</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">d450ffd0-972e-4398-ab49-6ba9e29e2499</span><span class="w"></span>
<span class="w">      </span><span class="nt">updated_at</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2020-04-07T14:08:34Z&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">availability_zone_hints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">      </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">dns_domain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_admin_state_up</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_port_security_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_router_external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_shared</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">      </span><span class="nt">is_vlan_transparent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">mtu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1450</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_net</span><span class="w"></span>
<span class="w">      </span><span class="nt">provider_network_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">provider_physical_network</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">provider_segmentation_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">qos_policy_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">segments</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack.network.Network</span><span class="w"></span>
</pre></div>
</div>
<p>You may edit the file as needed and then run the “import_networks”
playbook to import the networks from this file into the destination
cloud:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/import_networks.yml
</pre></div>
</div>
<p>You can repeat this process for other resources like subnets, security
groups, security group rules, routers, router interfaces, images and
keypairs.</p>
<p>For a full list of available playbooks, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ls <span class="nv">$OSM_DIR</span>/playbooks
</pre></div>
</div>
</section>
<section id="diagrams">
<h3>Diagrams<a class="headerlink" href="#diagrams" title="Permalink to this heading"></a></h3>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="../_images/pre-workload-migration-workflow.png"><img alt="Pre-workload Migration (workflow)" src="../_images/pre-workload-migration-workflow.png" style="width: 50%;" /></a>
<figcaption>
<p><span class="caption-text">Pre-workload Migration (workflow)</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="../_images/pre-workload-migration-data-flow.png"><img alt="Pre-workload Migration (data flow)" src="../_images/pre-workload-migration-data-flow.png" style="width: 50%;" /></a>
<figcaption>
<p><span class="caption-text">Pre-workload Migration (data flow)</span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>
<section id="demo">
<h3>Demo<a class="headerlink" href="#demo" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://youtu.be/e7KXy5Hq4CMA">Pre-workload migration recorded demo</a>:</p>
<p><a class="reference external" href="https://youtu.be/e7KXy5Hq4CMA"><img alt="Watch the video1" src="https://img.youtube.com/vi/e7KXy5Hq4CM/maxresdefault.jpg" /></a></p>
</section>
</section>
<section id="workload-migration">
<h2>Workload migration<a class="headerlink" href="#workload-migration" title="Permalink to this heading"></a></h2>
<p>Workload information is exported in a similar method to networks,
security groups, etc. as in the previous sections. Run the
“export_workloads” playbook, and edit the resulting workloads.yml as
desired:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.4.0</span><span class="w"></span>
<span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">_info</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">addresses</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">external_network</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">OS-EXT-IPS-MAC:mac_addr</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fa:16:3e:98:19:a0</span><span class="w"></span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">OS-EXT-IPS:type</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fixed</span><span class="w"></span>
<span class="w">        </span><span class="nt">addr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.19.2.41</span><span class="w"></span>
<span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">    </span><span class="nt">flavor_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">a96b2815-3525-4eea-9ab4-14ba58e17835</span><span class="w"></span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0025f062-f684-4e02-9da2-3219e011ec74</span><span class="w"></span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SHUTOFF</span><span class="w"></span>
<span class="w">  </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">flavor_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m1.small</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">migration-vm</span><span class="w"></span>
<span class="w">    </span><span class="nt">security_group_names</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testing123</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span><span class="w"></span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack.compute.Server</span><span class="w"></span>
</pre></div>
</div>
<p>Note that this playbook only extracts metadata about servers in the
specified tenant - it does not download OpenStack volumes directly to
the migration data directory. Data transfer is handled by the
import_workloads playbook. The data is transfered directly between the
clouds, meaning both clouds have to be running and reachable at the
same time. The following sections describe the process in more detail.</p>
<section id="process-summary">
<h3>Process Summary<a class="headerlink" href="#process-summary" title="Permalink to this heading"></a></h3>
<p>This flowchart illustrates the high-level migration workflow, from a
user’s point of view:</p>
<figure class="align-default" id="id5">
<a class="reference internal image-reference" href="../_images/workload-migration-workflow.png"><img alt="Workload migration (workflow)" src="../_images/workload-migration-workflow.png" style="width: 50%;" /></a>
<figcaption>
<p><span class="caption-text">Workload migration (workflow)</span><a class="headerlink" href="#id5" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The process involves the deployment of a “conversion host” on source
and destination clouds. A conversion host is an OpenStack server which
will be used to transfer binary volume data from the source to the
destination cloud. The conversion hosts are expected to be created
from CentOS 8 or RHEL 8 cloud images.</p>
<p>The following diagram helps explain the need for a conversion host VM:</p>
<figure class="align-default" id="id6">
<a class="reference internal image-reference" href="../_images/workload-migration-data-flow.png"><img alt="Workload migration (data flow)" src="../_images/workload-migration-data-flow.png" style="width: 80%;" /></a>
<figcaption>
<p><span class="caption-text">Workload migration (data flow)</span><a class="headerlink" href="#id6" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>This shows that volumes on the source and destination clouds are
removed from their original VMs and attached to their respective
conversion hosts, and then transferred over the network from the
source conversion host to the destination. The tooling inside the
conversion host migrates one server by automating these actions on
the source and destination clouds:</p>
<p>Source Cloud:</p>
<ul class="simple">
<li><p>Detach volumes from the target server to migrate</p></li>
<li><p>Attach the volumes to the source conversion host</p></li>
<li><p>Export the volumes as block devices and wait for destination
conversion host to connect</p></li>
</ul>
<p>Destination Cloud:</p>
<ul class="simple">
<li><p>Create new volumes on the destination conversion host, one for each
source volume</p></li>
<li><p>Attach the new volumes to the destination conversion host</p></li>
<li><p>Connect to the block devices exported by source conversion host, and
copy the data to the new attached volumes</p></li>
<li><p>Detach the volumes from the destination conversion host</p></li>
<li><p>Create a new server using the new volumes</p></li>
</ul>
<p>This method keeps broad compatibility with the various flavors and
configurations of OpenStack using as much of an API-only approach as
possible, while allowing the use of libguestfs-based tooling to minimize
total data transfer.</p>
</section>
<section id="preparation">
<h3>Preparation<a class="headerlink" href="#preparation" title="Permalink to this heading"></a></h3>
<p>We’ll put additional parameters into <code class="docutils literal notranslate"><span class="pre">os-migrate-vars.yml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_conversion_external_network_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">public</span><span class="w"></span>
<span class="nt">os_migrate_conversion_flavor_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m1.large</span><span class="w"></span>
</pre></div>
</div>
<p>These define the flavor and external network we want to use for our
conversion hosts.</p>
<p>By default the migration will use an image named <code class="docutils literal notranslate"><span class="pre">os_migrate_conv</span></code> for
conversion hosts. Make sure this image exists in Glance on both clouds.
Currently it should be a
<a class="reference external" href="https://cloud.centos.org/centos/8/x86_64/images/CentOS-8-GenericCloud-8.2.2004-20200611.2.x86_64.qcow2">CentOS 8 Cloud Image</a>
or
<a class="reference external" href="https://access.redhat.com/downloads/content/479/ver=/rhel---8/8.3/x86_64/product-software">RHEL 8 KVM Guest Image</a>.</p>
<p>When using RHEL as conversion host, make sure to set the necessary <a class="reference external" href="https://os-migrate.github.io/os-migrate/user/variables-guide.html#conversion-host-rhel-variables">RHEL variables</a>.</p>
</section>
<section id="conversion-host-deployment">
<h3>Conversion host deployment<a class="headerlink" href="#conversion-host-deployment" title="Permalink to this heading"></a></h3>
<p>The conversion host deployment playbook creates the servers, installs
additional required packages, and authorizes the destination conversion
host to connect to the source conversion host for the actual data
transfer.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/deploy_conversion_hosts.yml
</pre></div>
</div>
</section>
<section id="export">
<h3>Export<a class="headerlink" href="#export" title="Permalink to this heading"></a></h3>
<p>Before migrating workloads, the destination cloud must have imported all
other resources (networks, security groups, etc.) or the migration will
fail. Matching named resources (including flavor names) must exist on
the destination before the servers are created.</p>
<p>Export workload information with the export_workloads playbook. Each
server listed in the resulting workloads.yml will be migrated,
except for the one matching the name given to the source conversion
host server.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/export_workloads.yml
</pre></div>
</div>
<p>The resulting workloads.yml file will look similar to:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">os_migrate_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5.0</span><span class="w"></span>
<span class="nt">resources</span><span class="p">:</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">_info</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">created_at</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2020-11-12T17:55:40Z&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">flavor_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cd6258f9-c34b-4a9c-a1e2-8cb81826781e</span><span class="w"></span>
<span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">af615f8c-378a-4a2e-be6a-b4d38a954242</span><span class="w"></span>
<span class="w">    </span><span class="nt">launched_at</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2020-11-12T17:56:00.000000&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">security_group_ids</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1359ec88-4873-40d2-aa0b-18ad0588f107</span><span class="w"></span>
<span class="w">    </span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SHUTOFF</span><span class="w"></span>
<span class="w">    </span><span class="nt">updated_at</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;2020-11-12T17:56:30Z&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">user_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">48be0a2e86a84682b8e4992a65d39e3e</span><span class="w"></span>
<span class="w">  </span><span class="nt">_migration_params</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">boot_disk_copy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<span class="w">  </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">availability_zone</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nova</span><span class="w"></span>
<span class="w">    </span><span class="nt">config_drive</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_server</span><span class="w"></span>
<span class="w">    </span><span class="nt">disk_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MANUAL</span><span class="w"></span>
<span class="w">    </span><span class="nt">flavor_ref</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">m1.xtiny</span><span class="w"></span>
<span class="w">      </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">    </span><span class="nt">image_ref</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cirros-0.4.0-x86_64-disk.img</span><span class="w"></span>
<span class="w">      </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">    </span><span class="nt">key_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_key</span><span class="w"></span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_server</span><span class="w"></span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">_info</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">device_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">af615f8c-378a-4a2e-be6a-b4d38a954242</span><span class="w"></span>
<span class="w">        </span><span class="nt">device_owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute:nova</span><span class="w"></span>
<span class="w">        </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cf5d73c3-089b-456b-abb9-dc5da988844e</span><span class="w"></span>
<span class="w">      </span><span class="nt">_migration_params</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
<span class="w">      </span><span class="nt">params</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">fixed_ips_refs</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip_address</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.20.7</span><span class="w"></span>
<span class="w">          </span><span class="nt">subnet_ref</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_subnet</span><span class="w"></span>
<span class="w">            </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">network_ref</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_net</span><span class="w"></span>
<span class="w">          </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack.network.ServerPort</span><span class="w"></span>
<span class="w">    </span><span class="nt">scheduler_hints</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">    </span><span class="nt">security_group_refs</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">osm_security_group</span><span class="w"></span>
<span class="w">      </span><span class="nt">project_name</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;%auth%&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[]</span><span class="w"></span>
<span class="w">    </span><span class="nt">user_data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span><span class="w"></span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openstack.compute.Server</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="migration-parameters">
<h3>Migration parameters<a class="headerlink" href="#migration-parameters" title="Permalink to this heading"></a></h3>
<p>You can edit the exported <code class="docutils literal notranslate"><span class="pre">workloads.yml</span></code> to adjust desired
properties for the servers which will be created in the destination
cloud during migration. You can also edit migration parameters to
control how a workload should be migrated. Refer to
<a class="reference external" href="migration-params-guide.html">Migration Parameters Guide</a>
for more information.</p>
</section>
<section id="ansible-variables">
<h3>Ansible Variables<a class="headerlink" href="#ansible-variables" title="Permalink to this heading"></a></h3>
<p>In addition to the migration parameters in the resource YAML files,
you can alter the behavior of OS Migrate via Ansible variables,
e.g. to specify a subset of resources/workloads that will be exported
or imported. Refer to the <a class="reference external" href="variables-guide.html">Variables Guide</a> for
details.</p>
</section>
<section id="migration">
<h3>Migration<a class="headerlink" href="#migration" title="Permalink to this heading"></a></h3>
<p>Then run the import_workloads playbook to migrate the workloads:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/import_workloads.yml
</pre></div>
</div>
<p>Any server marked “changed” should be successfully migrated to the
destination cloud. Servers are “skipped” if they match the name or
ID of the specified conversion host. If there is already an server
on the destination matching the name of the current server, it will
be marked “ok” and no extra work will be performed.</p>
</section>
<section id="cleanup-of-conversion-hosts">
<h3>Cleanup of conversion hosts<a class="headerlink" href="#cleanup-of-conversion-hosts" title="Permalink to this heading"></a></h3>
<p>When you are done migrating workloads in given tenants, delete their
conversion hosts via the delete_conversion_hosts playbook:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">$OSM_CMD</span> <span class="nv">$OSM_DIR</span>/playbooks/delete_conversion_hosts.yml
</pre></div>
</div>
</section>
<section id="id1">
<h3>Demo<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h3>
<p><a class="reference external" href="https://youtu.be/gEKvgIZqrQY">Workload migration recorded demo</a>:</p>
<p><a class="reference external" href="https://youtu.be/gEKvgIZqrQY"><img alt="Watch the video2" src="https://img.youtube.com/vi/gEKvgIZqrQY/maxresdefault.jpg" /></a></p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="upgrade.html" class="btn btn-neutral float-left" title="Upgrading" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="usage-notes.html" class="btn btn-neutral float-right" title="General usage notes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, os-migrate.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>